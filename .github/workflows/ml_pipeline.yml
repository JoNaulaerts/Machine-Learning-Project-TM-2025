name: ML Model Training & Deployment Pipeline

on:
  push:
    branches: [ main ]
    paths:
      - 'Dataset_1_UK_Housing/Code/**'
      - 'Dataset_2_UK_Historic_Electricity_Demand_Data/Code/**'
      - '.github/workflows/**'
      - 'requirements.txt'
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * 0'  # Weekly retraining on Sundays

jobs:
  train-housing-model:
    runs-on: ubuntu-latest
    name: Train Housing Price Model
    permissions:
      contents: write
      packages: write
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
        cache: 'pip'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        
    - name: Download Housing Data (sample)
      run: |
        cd Dataset_1_UK_Housing/Code
        python -c "
        import pandas as pd
        import numpy as np
        from pathlib import Path
        
        # Create sample data for training
        print('ðŸ“Š Generating sample housing data...')
        np.random.seed(42)
        n_samples = 10000
        
        data = {
            'total_floor_area': np.random.randint(50, 300, n_samples),
            'property_type_F': np.random.randint(0, 2, n_samples),
            'property_type_S': np.random.randint(0, 2, n_samples),
            'property_type_D': np.random.randint(0, 2, n_samples),
            'property_type_T': np.random.randint(0, 2, n_samples),
            'new_build': np.random.randint(0, 2, n_samples),
            'latitude': np.random.uniform(50, 55, n_samples),
            'longitude': np.random.uniform(-5, 2, n_samples),
            'year': np.random.randint(2015, 2024, n_samples),
            'month': np.random.randint(1, 13, n_samples),
        }
        
        # Generate realistic prices
        df = pd.DataFrame(data)
        df['price'] = (
            df['total_floor_area'] * 2000 +
            df['property_type_F'] * 50000 +
            df['new_build'] * 30000 +
            np.random.normal(200000, 50000, n_samples)
        )
        
        Path('data_temp').mkdir(exist_ok=True)
        df.to_parquet('data_temp/housing_sample.parquet')
        print(f'âœ… Generated {len(df)} sample records')
        "
        
    - name: Train Housing Model
      run: |
        cd Dataset_1_UK_Housing/Code
        python -c "
        import pandas as pd
        import numpy as np
        from sklearn.linear_model import Ridge
        from sklearn.ensemble import RandomForestRegressor
        from sklearn.model_selection import train_test_split
        from sklearn.preprocessing import StandardScaler
        from sklearn.metrics import mean_squared_error, mean_absolute_error, r2_score
        import joblib
        from pathlib import Path
        import json
        from datetime import datetime
        
        print('ðŸ  Training Housing Price Prediction Models...')
        
        # Load data
        df = pd.read_parquet('data_temp/housing_sample.parquet')
        X = df.drop(['price'], axis=1)
        y = df['price']
        
        # Split data
        X_train, X_test, y_train, y_test = train_test_split(
            X, y, test_size=0.2, random_state=42
        )
        
        # Scale features
        scaler = StandardScaler()
        X_train_scaled = scaler.fit_transform(X_train)
        X_test_scaled = scaler.transform(X_test)
        
        # Train Ridge Regression
        print('ðŸ”§ Training Ridge Regression...')
        ridge_model = Ridge(alpha=1.0, random_state=42)
        ridge_model.fit(X_train_scaled, y_train)
        
        ridge_pred = ridge_model.predict(X_test_scaled)
        ridge_metrics = {
            'model': 'Ridge Regression',
            'rmse': float(np.sqrt(mean_squared_error(y_test, ridge_pred))),
            'mae': float(mean_absolute_error(y_test, ridge_pred)),
            'r2': float(r2_score(y_test, ridge_pred)),
            'timestamp': datetime.now().isoformat()
        }
        
        # Train Random Forest
        print('ðŸ”§ Training Random Forest...')
        rf_model = RandomForestRegressor(
            n_estimators=100, 
            max_depth=10, 
            random_state=42,
            n_jobs=-1
        )
        rf_model.fit(X_train, y_train)
        
        rf_pred = rf_model.predict(X_test)
        rf_metrics = {
            'model': 'Random Forest',
            'rmse': float(np.sqrt(mean_squared_error(y_test, rf_pred))),
            'mae': float(mean_absolute_error(y_test, rf_pred)),
            'r2': float(r2_score(y_test, rf_pred)),
            'timestamp': datetime.now().isoformat()
        }
        
        # Save models
        print('ðŸ’¾ Saving models...')
        joblib.dump(ridge_model, 'ridge_model.pkl')
        joblib.dump(rf_model, 'random_forest_model.pkl')
        joblib.dump(scaler, 'scaler.pkl')
        
        # Save metrics
        metrics = {
            'housing_models': [ridge_metrics, rf_metrics],
            'training_samples': len(X_train),
            'test_samples': len(X_test)
        }
        
        with open('model_metrics.json', 'w') as f:
            json.dump(metrics, f, indent=2)
        
        print('âœ… Housing models trained successfully!')
        print(f'Ridge - RMSE: {ridge_metrics[\"rmse\"]:.2f}, RÂ²: {ridge_metrics[\"r2\"]:.4f}')
        print(f'Random Forest - RMSE: {rf_metrics[\"rmse\"]:.2f}, RÂ²: {rf_metrics[\"r2\"]:.4f}')
        "
        
    - name: Commit Housing Models
      run: |
        git config --global user.name 'GitHub Actions Bot'
        git config --global user.email 'actions@github.com'
        cd Dataset_1_UK_Housing/Code
        git add *.pkl model_metrics.json || true
        git diff --staged --quiet || git commit -m "ðŸ¤– Auto-train: Housing models updated [skip ci]" || true
        git push || echo "No changes to push"

  train-electricity-model:
    runs-on: ubuntu-latest
    name: Train Electricity Forecast Model
    permissions:
      contents: write
      packages: write
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
        cache: 'pip'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        
    - name: Generate Electricity Data (sample)
      run: |
        cd Dataset_2_UK_Historic_Electricity_Demand_Data/Code
        python -c "
        import pandas as pd
        import numpy as np
        from datetime import datetime, timedelta
        from pathlib import Path
        
        print('âš¡ Generating sample electricity demand data...')
        
        # Generate time series data
        start_date = datetime(2020, 1, 1)
        periods = 48 * 365  # 2 years of half-hourly data
        
        dates = [start_date + timedelta(minutes=30*i) for i in range(periods)]
        
        df = pd.DataFrame({
            'settlement_date': [d.date() for d in dates],
            'settlement_period': [(d.hour * 2 + d.minute // 30 + 1) for d in dates],
            'england_wales_demand': [
                25000 + 
                5000 * np.sin(2 * np.pi * i / 48) +  # Daily pattern
                2000 * np.sin(2 * np.pi * i / (48 * 7)) +  # Weekly pattern
                np.random.normal(0, 1000)  # Noise
                for i in range(periods)
            ]
        })
        
        Path('data_temp').mkdir(exist_ok=True)
        df.to_csv('data_temp/electricity_sample.csv', index=False)
        print(f'âœ… Generated {len(df)} sample records')
        "
        
    - name: Train Electricity Models
      run: |
        cd Dataset_2_UK_Historic_Electricity_Demand_Data/Code
        python -c "
        import pandas as pd
        import numpy as np
        from xgboost import XGBRegressor
        from sklearn.ensemble import GradientBoostingRegressor
        from sklearn.metrics import mean_squared_error, mean_absolute_error, r2_score
        import joblib
        import json
        from datetime import datetime
        
        print('âš¡ Training Electricity Demand Forecast Models...')
        
        # Load data
        df = pd.read_csv('data_temp/electricity_sample.csv')
        df['settlement_date'] = pd.to_datetime(df['settlement_date'])
        df = df.sort_values('settlement_date')
        
        # Feature engineering
        df['hour'] = df['settlement_period'] // 2
        df['day_of_week'] = df['settlement_date'].dt.dayofweek
        df['month'] = df['settlement_date'].dt.month
        df['day_of_year'] = df['settlement_date'].dt.dayofyear
        df['week_of_year'] = df['settlement_date'].dt.isocalendar().week
        
        # Lag features
        for lag in [1, 2, 48, 336]:  # 30min, 1hr, 1day, 1week
            df[f'demand_lag_{lag}'] = df['england_wales_demand'].shift(lag)
        
        df = df.dropna()
        
        # Prepare features
        feature_cols = ['hour', 'day_of_week', 'month', 'day_of_year', 'week_of_year'] + \
                       [f'demand_lag_{lag}' for lag in [1, 2, 48, 336]]
        
        X = df[feature_cols]
        y = df['england_wales_demand']
        
        # Time-based split (80% train, 20% test)
        split_idx = int(len(df) * 0.8)
        X_train, X_test = X[:split_idx], X[split_idx:]
        y_train, y_test = y[:split_idx], y[split_idx:]
        
        # Train XGBoost
        print('ðŸ”§ Training XGBoost...')
        xgb_model = XGBRegressor(
            n_estimators=200,
            max_depth=6,
            learning_rate=0.1,
            random_state=42,
            n_jobs=-1
        )
        xgb_model.fit(X_train, y_train)
        
        xgb_pred = xgb_model.predict(X_test)
        xgb_metrics = {
            'model': 'XGBoost',
            'rmse': float(np.sqrt(mean_squared_error(y_test, xgb_pred))),
            'mae': float(mean_absolute_error(y_test, xgb_pred)),
            'r2': float(r2_score(y_test, xgb_pred)),
            'timestamp': datetime.now().isoformat()
        }
        
        # Train Gradient Boosting
        print('ðŸ”§ Training Gradient Boosting...')
        gb_model = GradientBoostingRegressor(
            n_estimators=100,
            max_depth=5,
            learning_rate=0.1,
            random_state=42
        )
        gb_model.fit(X_train, y_train)
        
        gb_pred = gb_model.predict(X_test)
        gb_metrics = {
            'model': 'Gradient Boosting',
            'rmse': float(np.sqrt(mean_squared_error(y_test, gb_pred))),
            'mae': float(mean_absolute_error(y_test, gb_pred)),
            'r2': float(r2_score(y_test, gb_pred)),
            'timestamp': datetime.now().isoformat()
        }
        
        # Save models
        print('ðŸ’¾ Saving models...')
        joblib.dump(xgb_model, 'xgboost_model.pkl')
        joblib.dump(gb_model, 'gradient_boosting_model.pkl')
        
        # Save metrics
        metrics = {
            'electricity_models': [xgb_metrics, gb_metrics],
            'training_samples': len(X_train),
            'test_samples': len(X_test),
            'features': feature_cols
        }
        
        with open('model_metrics.json', 'w') as f:
            json.dump(metrics, f, indent=2)
        
        print('âœ… Electricity models trained successfully!')
        print(f'XGBoost - RMSE: {xgb_metrics[\"rmse\"]:.2f}, RÂ²: {xgb_metrics[\"r2\"]:.4f}')
        print(f'Gradient Boosting - RMSE: {gb_metrics[\"rmse\"]:.2f}, RÂ²: {gb_metrics[\"r2\"]:.4f}')
        "
        
    - name: Commit Electricity Models
      run: |
        git config --global user.name 'GitHub Actions Bot'
        git config --global user.email 'actions@github.com'
        cd Dataset_2_UK_Historic_Electricity_Demand_Data/Code
        git add *.pkl model_metrics.json || true
        git diff --staged --quiet || git commit -m "ðŸ¤– Auto-train: Electricity models updated [skip ci]" || true
        git push || echo "No changes to push"

  build-docker-images:
    needs: [train-housing-model, train-electricity-model]
    runs-on: ubuntu-latest
    name: Build & Test Docker Images
    permissions:
      contents: read
      packages: write
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v2
      
    - name: Build Housing App Image
      run: |
        echo "ðŸ³ Building Housing Prediction App Docker image..."
        docker build -f Dockerfile.housing -t housing-prediction-app:latest .
        echo "âœ… Housing app image built successfully"
        
    - name: Build Electricity App Image
      run: |
        echo "ðŸ³ Building Electricity Forecast App Docker image..."
        docker build -f Dockerfile.electricity -t electricity-forecast-app:latest .
        echo "âœ… Electricity app image built successfully"
        
    - name: Test Docker Images
      run: |
        echo "ðŸ§ª Testing Docker images..."
        docker images | grep -E "(housing|electricity)"
        echo "âœ… Docker images ready for deployment"

  deploy-to-oracle-cloud:
    needs: [build-docker-images]
    runs-on: ubuntu-latest
    name: Deploy to Oracle Cloud
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      
    - name: Setup SSH Key
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.ORACLE_SSH_KEY }}" > ~/.ssh/oracle_key
        chmod 600 ~/.ssh/oracle_key
        ssh-keyscan -H ${{ secrets.ORACLE_HOST }} >> ~/.ssh/known_hosts
        
    - name: Deploy to Oracle VM
      run: |
        echo "ðŸš€ Deploying to Oracle Cloud..."
        
        # Copy docker-compose and Dockerfiles to Oracle VM
        scp -i ~/.ssh/oracle_key \
          docker-compose.yml \
          Dockerfile.housing \
          Dockerfile.electricity \
          requirements-docker.txt \
          ${{ secrets.ORACLE_USER }}@${{ secrets.ORACLE_HOST }}:~/ml-project/
        
        # Copy Streamlit app code
        scp -i ~/.ssh/oracle_key -r \
          Dataset_1_UK_Housing/Code/streamlit_app.py \
          ${{ secrets.ORACLE_USER }}@${{ secrets.ORACLE_HOST }}:~/ml-project/housing_app/
        
        scp -i ~/.ssh/oracle_key -r \
          Dataset_2_UK_Historic_Electricity_Demand_Data/Code/streamlit_app.py \
          ${{ secrets.ORACLE_USER }}@${{ secrets.ORACLE_HOST }}:~/ml-project/electricity_app/
        
        # SSH and deploy
        ssh -i ~/.ssh/oracle_key ${{ secrets.ORACLE_USER }}@${{ secrets.ORACLE_HOST }} << 'ENDSSH'
          cd ~/ml-project
          
          # Install Docker if not present
          if ! command -v docker &> /dev/null; then
            echo "ðŸ“¦ Installing Docker..."
            curl -fsSL https://get.docker.com -o get-docker.sh
            sudo sh get-docker.sh
            sudo usermod -aG docker $USER
            sudo systemctl enable docker
            sudo systemctl start docker
          fi
          
          # Install docker-compose if not present
          if ! command -v docker-compose &> /dev/null; then
            echo "ðŸ“¦ Installing docker-compose..."
            sudo curl -L "https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
            sudo chmod +x /usr/local/bin/docker-compose
          fi
          
          # Stop existing containers
          docker-compose down || true
          
          # Build and start containers
          echo "ðŸ³ Building Docker images..."
          docker-compose build
          
          echo "ðŸš€ Starting containers..."
          docker-compose up -d
          
          # Show status
          docker-compose ps
          
          echo "âœ… Deployment complete!"
          echo "ðŸŒ Housing App: http://${{ secrets.ORACLE_HOST }}:8501"
          echo "âš¡ Electricity App: http://${{ secrets.ORACLE_HOST }}:8502"
        ENDSSH
        
    - name: Deployment Summary
      run: |
        echo "ðŸš€ DEPLOYMENT SUMMARY"
        echo "===================="
        echo ""
        echo "âœ… Models Trained:"
        echo "  - Housing: Ridge Regression + Random Forest"
        echo "  - Electricity: XGBoost + Gradient Boosting"
        echo ""
        echo "âœ… Docker Images Built & Deployed"
        echo ""
        echo "ðŸŒ Live Applications:"
        echo "  - Housing: http://${{ secrets.ORACLE_HOST }}:8501"
        echo "  - Electricity: http://${{ secrets.ORACLE_HOST }}:8502"
        echo ""
        echo "âœ… Pipeline Complete!"

  create-deployment-badge:
    needs: [deploy-to-oracle-cloud]
    runs-on: ubuntu-latest
    name: Update Deployment Status
    permissions:
      contents: write
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Update README with Status
      run: |
        echo "ðŸ“Š Updating deployment status..."
        
        cat > DEPLOYMENT_STATUS.md << 'EOF'
        # ðŸš€ Deployment Status
        
        **Last Updated:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")
        **Build:** #${{ github.run_number }}
        **Commit:** ${{ github.sha }}
        
        ## âœ… Training Status
        
        - **Housing Models:** Trained & Ready
        - **Electricity Models:** Trained & Ready
        - **Docker Images:** Built & Tested
        
        ## ðŸ“Š Model Performance
        
        ### Housing Price Prediction
        - Ridge Regression: Trained
        - Random Forest: Trained
        
        ### Electricity Demand Forecasting
        - XGBoost: Trained
        - Gradient Boosting: Trained
        
        ## ðŸŒ Deployment Options
        
        1. **Streamlit Cloud** - Free hosting
        2. **Docker Compose** - Local deployment
        3. **AWS/Oracle Cloud** - Cloud hosting
        
        ---
        *Auto-generated by GitHub Actions*
        EOF
        
        git config --global user.name 'GitHub Actions Bot'
        git config --global user.email 'actions@github.com'
        git add DEPLOYMENT_STATUS.md || true
        git diff --staged --quiet || git commit -m "ðŸ“Š Update deployment status [skip ci]" || true
        git push || echo "No changes to push"
